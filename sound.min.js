var AudioContext = window.AudioContext // Default
    || window.webkitAudioContext; // Safari and old versions of Chrome
var context = new AudioContext; // Create and Initialize the Audio Context
context.onstatechange = function() {
    if (context.state === "suspended") { context.resume(); }
}
var soundUrlArr=["http://oozvvnyjf.bkt.clouddn.com/s1.wav","http://oozvvnyjf.bkt.clouddn.com/s2.wav","http://oozvvnyjf.bkt.clouddn.com/s3.wav","http://oozvvnyjf.bkt.clouddn.com/s4.wav","sounds/s5.aac",
"sounds/s6.aac"]
var soundBuffer, sound, soundBuffer1,soundBuffer2,soundBuffer3,soundBuffer4;
// initialize encoder
var encoder = new ambisonics.monoEncoder(context, 3);
var analyser = new ambisonics.intensityAnalyser(context);
var gainOut = context.createGain();
var output=new ambisonics.binDecoder(context,3);
encoder.out.connect(output.in);
output.out.connect(context.destination);
encoder.out.connect(analyser.in);
var count=0,timers,flag;
timers=setInterval(function(){
    count++;
},1000)
var oLoading=document.getElementById('loadings');
function loadSample(url, doAfterLoading) {
    var fetchSound = new XMLHttpRequest(); // Load the Sound with XMLHttpRequest
    fetchSound.open("GET", soundUrlArr[0], true); // Path to Audio File
    fetchSound.responseType = "arraybuffer"; // Read as Binary Data
    fetchSound.onload = function() {
        context.decodeAudioData(fetchSound.response, doAfterLoading, onDecodeAudioDataError);

        var fetchSound2 = new XMLHttpRequest(); // Load the Sound with XMLHttpRequest
        fetchSound2.open("GET", soundUrlArr[1], true); // Path to Audio File
        fetchSound2.responseType = "arraybuffer"; // Read as Binary Data
        fetchSound2.onload = function() {
            context.decodeAudioData(fetchSound2.response, assignSample2SoundBuffer2, onDecodeAudioDataError);            

            var fetchSound3 = new XMLHttpRequest(); // Load the Sound with XMLHttpRequest
            fetchSound3.open("GET", soundUrlArr[2], true); // Path to Audio File
            fetchSound3.responseType = "arraybuffer"; // Read as Binary Data
            fetchSound3.onload = function() {
                context.decodeAudioData(fetchSound3.response, assignSample2SoundBuffer3, onDecodeAudioDataError);

                var fetchSound4 = new XMLHttpRequest(); // Load the Sound with XMLHttpRequest
                fetchSound4.open("GET", soundUrlArr[3], true); // Path to Audio File
                fetchSound4.responseType = "arraybuffer"; // Read as Binary Data
                fetchSound4.onload = function() {
                    context.decodeAudioData(fetchSound4.response, assignSample2SoundBuffer4, onDecodeAudioDataError);              
                }
                fetchSound4.send();

            }
            fetchSound3.send();

        }
        fetchSound2.send();
       
    }
    fetchSound.send();
}

var assignSample2SoundBuffer = function(decodedBuffer) {
        var  buffer1 =decodedBuffer.getChannelData(0);  
         var  oduration=decodedBuffer.duration;
         var framecount=(oduration/16)*context.sampleRate;//context.sampleRate*24.0;
         var channels=16;
         var  myArrayBuffer=context.createBuffer(4, framecount,context.sampleRate);    
        var i=0;
         for (var channel = 0; channel < channels; channel++) 
            {
                 
                 if(channel%4==0)
                    {
                      var nowBuffering =  myArrayBuffer.getChannelData(channel/4);
                      for( var i=0;i<=buffer1.length/16;i++)   
                         {
                            nowBuffering[i]=buffer1[i*16+channel]; 
                          }
                    }
           }
        soundBuffer1 = myArrayBuffer;
        console.log(soundBuffer1.duration)

		 if(count>1&&paused==true&&flag==true)
        {
            clearInterval(timers);
            //alert("The 3D sound has been loaded. You can click the play button to play it");
			oLoading.style.display='none';
        }
    }
    var assignSample2SoundBuffer2 = function(decodedBuffer) {
         var  buffer1 =decodedBuffer.getChannelData(0);  
         var  oduration=decodedBuffer.duration;
         var framecount=(oduration/16)*context.sampleRate;//context.sampleRate*24.0;
         var channels=16;
         var  myArrayBuffer2=context.createBuffer(4, framecount,context.sampleRate);    
        var i=0;
         for (var channel = 0; channel < channels; channel++) 
            {
                 
                 if(channel%4==0)
                    {
                      var nowBuffering =  myArrayBuffer2.getChannelData(channel/4);
                      for( var i=0;i<=buffer1.length/16;i++)  
                         {
                            nowBuffering[i]=buffer1[i*16+channel]; 
                          }
                    }
           }
        soundBuffer2 = myArrayBuffer2;
        oLoading.style.display='none';
        
    }
    var assignSample2SoundBuffer3 = function(decodedBuffer) {
          var  buffer1 =decodedBuffer.getChannelData(0);  
               var  oduration=decodedBuffer.duration;
               var framecount=(oduration/16)*context.sampleRate;//context.sampleRate*24.0;
               var channels=16;
               var  myArrayBuffer3=context.createBuffer(4, framecount,context.sampleRate);    
              var i=0;
               for (var channel = 0; channel < channels; channel++) 
                  {
                       
                       if(channel%4==0)
                          {
                            var nowBuffering =  myArrayBuffer3.getChannelData(channel/4);
                            for( var i=0;i<=buffer1.length/16;i++)   //Êý¾Ý³¤¶ÈÎªbuffer>length£¬
                               {
                                  nowBuffering[i]=buffer1[i*16+channel]; 
                                }
                          }
                 }
            soundBuffer3 = myArrayBuffer3;
            oLoading.style.display='none'; 
    }
    var assignSample2SoundBuffer4 = function(decodedBuffer) {
         var  buffer1 =decodedBuffer.getChannelData(0);  
         var  oduration=decodedBuffer.duration;
         var framecount=(oduration/16)*context.sampleRate;//context.sampleRate*24.0;
         var channels=16;
         var  myArrayBuffer4=context.createBuffer(4, framecount,context.sampleRate);    
        var i=0;
         for (var channel = 0; channel < channels; channel++) 
            {
                 
                 if(channel%4==0)
                    {
                      var nowBuffering =  myArrayBuffer4.getChannelData(channel/4);
                      for( var i=0;i<=buffer1.length/16;i++)   //Êý¾Ý³¤¶ÈÎªbuffer>length£¬
                         {
                            nowBuffering[i]=buffer1[i*16+channel]; 
                          }
                    }
           }
        soundBuffer4 = myArrayBuffer4;
        oLoading.style.display='none';
    }

var assignSample2Filters = function(decodedBuffer) {
  
}

// load and assign samples
loadSample(soundUrlArr, assignSample2SoundBuffer);
//loadSample(irUrl, assignSample2Filters);

function mouseActionLocal(angleXY) {
    encoder.azim = angleXY[0];
    encoder.elev = angleXY[1];
    encoder.updateGains();
}
   
    var i=0;
    // var startedAt;
    // var pausedAt;
    var paused=true;
    var browser=window.navigator.userAgent;
    function changeVolume(volumeBarPoint){
    	var vValue=volumeBarPoint;
    	gainOut.gain.value=vValue;
    	console.log(vValue);
    }
    //声音调到最大
    function volumeMax(){
    	gainOut.gain.value=1;
    }
    //声音调至最小
    function volumeMin(){
    	gainOut.gain.value=0;
    }
    var timer;
    var krpano=document.getElementById('krpanoSWFObject');
    function playToggles(seek){
    		if(paused){    			
    		    sound = context.createBufferSource();
                console.log('播放');
    		    if(soundBuffer1 == undefined){
    		    	flag=true;
    		    	alert('Please pause for a moment and then play! ');
    		    	krpano.call(' plugin[video].pause(); plugin[video].seek(0); ');
					oLoading.style.display='block';
    		    }else if(seek<soundBuffer1.duration){
                        oLoading.style.display='none';
                        krpano.call(' plugin[video].play(); ');
                        paused = false;
                        clearInterval(timer);
                        sound.buffer = soundBuffer1;
                        sound.loop = true;
                        sound.connect(encoder.in);
                        sound.start(seek); 
    		    }else if(seek<soundBuffer2.duration+soundBuffer1.duration){
                            krpano.call(' plugin[video].play(); ');
                            sound = context.createBufferSource();
                            paused = false;
                            sound.buffer = soundBuffer2;
                            sound.loop = true;
                            sound.connect(encoder.in);
                            sound.start(seek-soundBuffer1.duration); 
                }else if(seek<soundBuffer2.duration+soundBuffer1.duration+soundBuffer3.duration){
                            krpano.call(' plugin[video].play(); ');
                            console.log('缓冲3');
                            sound = context.createBufferSource();
                            paused = false;
                            sound.buffer = soundBuffer3;
                            sound.loop = true;
                            sound.connect(encoder.in);
                            sound.start(0, seek-soundBuffer1.duration-soundBuffer2.duration);
                }else if(seek<soundBuffer2.duration+soundBuffer1.duration+soundBuffer4.duration+soundBuffer3.duration){
                            krpano.call(' plugin[video].play(); ');
                            console.log('缓冲4');
                            sound = context.createBufferSource();
                            paused = false;
                            sound.buffer = soundBuffer4;
                            sound.loop = true;
                            sound.connect(encoder.in);
                            sound.start(0, seek-soundBuffer1.duration-soundBuffer2.duration-soundBuffer3.duration);
                }
    	
    		}
			else {
                krpano.call(' plugin[video].pause(); ');
				paused = true;
                sound.stop(0);
    		}
    }
    
    
    function getPauseAt(pausePoint,totalTime){
        var second=pausePoint.toFixed(3);
        pausedAt=second*1000;
        var t1=pausedAt;
        setInterval(function(){
        	 t2=pausedAt;
        },1000)
        var gap=Math.abs(t1-t2);
        if(browser.toLowerCase().indexOf("mobile")>0){
            if(!paused){
	        	
                    sound.stop(0);
                    sound = context.createBufferSource();  
                    if(pausePoint<=soundBuffer1.duration)
                    {
                        sound.buffer = soundBuffer1;
                        sound.loop = true;
                        paused = false;
                        sound.connect(encoder.in);
                        sound.start(0, pausedAt / 1000);
                        if(pausePoint>=soundBuffer1.duration-1)
                        {
                            if(soundBuffer2 == undefined){
                                krpano.call(' plugin[video].pause(); ');
                                oLoading.style.display='block';
                                paused=true;
                                sound.stop(0);
                            }
                        }
                    }else if(pausePoint<=(soundBuffer1.duration+soundBuffer2.duration)){
                        sound = context.createBufferSource();
                        sound.buffer = soundBuffer2;
                        console.log(222);
                        sound.loop = true;
                        paused = false;
                        sound.connect(encoder.in);
                        sound.start(0, pausedAt / 1000-soundBuffer1.duration); 
                        if(pausePoint>=(soundBuffer1.duration+soundBuffer2.duration-1))
                        {
                            if(soundBuffer3 == undefined){
                                console.log('执行')
                                krpano.call(' plugin[video].pause(); ');
                                oLoading.style.display='block';
                                paused=true;
                                sound.stop(0);
                            }
                        }
                    }else if(pausePoint<=(soundBuffer1.duration+soundBuffer2.duration+soundBuffer3.duration)){
                        sound = context.createBufferSource();
                        sound.buffer = soundBuffer3;
                        console.log(333);
                        sound.loop = true;
                        paused = false;
                        sound.connect(encoder.in);
                        sound.start(0, pausedAt / 1000-soundBuffer1.duration-soundBuffer2.duration);  
                        if(pausePoint>=(soundBuffer1.duration+soundBuffer2.duration+soundBuffer3.duration-1))
                        {
                            if(soundBuffer4 == undefined){
                                krpano.call(' plugin[video].pause(); ');
                                oLoading.style.display='block';
                                paused=true;
                                sound.stop(0);
                            }
                        }
                    }else if(pausePoint<=(soundBuffer1.duration+soundBuffer2.duration+soundBuffer3.duration+soundBuffer4.duration)){
                        if(pausePoint>=totalTime)
                        {
                            sound.stop(0);
                        }
                        sound = context.createBufferSource();
                        sound.buffer = soundBuffer4;
                        sound.loop = true;
                        paused = false;
                        sound.connect(encoder.in);
                        sound.start(0, pausedAt / 1000-soundBuffer1.duration-soundBuffer2.duration-soundBuffer3.duration); 
                    }
	        }
        }
        else{
	        if((pausePoint>=totalTime)||gap<500){
	        	sound.stop(0);
	        }else if(!paused){
	        	    sound.stop(0);
	        	    sound = context.createBufferSource();
                    if(pausePoint<soundBuffer1.duration)
                    {
                        sound.buffer = soundBuffer1;
                        sound.loop = true;
                        paused = false;
                        sound.connect(encoder.in);
                        sound.start(0, pausedAt / 1000);  
                        if(pausePoint>=soundBuffer1.duration-1)
                        {
                            if(soundBuffer2 == undefined){
                                krpano.call(' plugin[video].pause(); ');
                                oLoading.style.display='block';
                                paused=true;
                                sound.stop(0);
                                console.log('unnnn');

                            }
                        }
                    }else if(pausePoint<(soundBuffer1.duration+soundBuffer2.duration)){
                        sound = context.createBufferSource();
                        sound.buffer = soundBuffer2;
                        sound.loop = true;
                        paused = false;
                        sound.connect(encoder.in);
                        sound.start(0, pausedAt / 1000-soundBuffer1.duration);   
                        if(pausePoint>=(soundBuffer1.duration+soundBuffer2.duration-1))
                        {
                            if(!soundBuffer3){
                                krpano.call(' plugin[video].pause(); ');
                                oLoading.style.display='block';
                                paused=true;
                                sound.stop(0);
                            }
                        }                       
                    }else if(pausePoint<(soundBuffer1.duration+soundBuffer2.duration+soundBuffer3.duration)){
                        sound = context.createBufferSource();
                        sound.buffer = soundBuffer3;
                        sound.loop = true;
                        paused = false;
                        sound.connect(encoder.in);
                        sound.start(0, pausedAt / 1000-soundBuffer1.duration-soundBuffer2.duration);
                        if(pausePoint>=(soundBuffer1.duration+soundBuffer2.duration+soundBuffer3.duration-1))
                        {
                            
                            if(soundBuffer4 == undefined){
                                krpano.call(' plugin[video].pause(); ');
                                oLoading.style.display='block';
                                paused=true;
                                sound.stop(0);
                            }
                        }                       
                    }else{                       
                        sound = context.createBufferSource();
                        sound.buffer = soundBuffer4;
                        sound.loop = true;
                        paused = false;
                        sound.connect(encoder.in);
                        sound.start(0, pausedAt / 1000-soundBuffer1.duration-soundBuffer2.duration-soundBuffer3.duration); 
                    }
	        
	        }
        }
    }
    function onDecodeAudioDataError(error) {
        var url = 'hjre';
      alert("Browser cannot decode audio data..." + "\n\nError: " + error + "\n\n(If you re using Safari and get a null error, this is most likely due to Apple's shady plan going on to stop the .ogg format from easing web developer's life :)");
    }